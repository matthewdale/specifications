description: "MONGODB-OIDC authentication with retry enabled"
schemaVersion: "1.18"
runOnRequirements:
- minServerVersion: "7.0"
  auth: true
  authMechanism: "MONGODB-OIDC"
createEntities:
- client:
    id: authClient
- client:
    id: client0
    uriOptions:
      authMechanism: "MONGODB-OIDC"
      # The $$placeholder document should be replaced by auth mechanism
      # properties that enable OIDC auth on the target cloud platform. For
      # example, when running the test on AWS, replace the $$placeholder
      # document with {"PROVIDER_NAME": "aws"}.
      authMechanismProperties: { $$placeholder: 1 }
      retryReads: true
      retryWrites: true
    observeEvents:
    - commandStartedEvent
    - commandSucceededEvent
    - commandFailedEvent
- database:
    id: database0
    client: client0
    databaseName: test
- collection:
    id: collection0
    database: database0
    collectionName: collName
initialData:
- collectionName: collName
  databaseName: test
  documents: []
tests:
- description: Read commands should fail if reauthentication fails
  operations:
  - name: failPoint
    object: testRunner
    arguments:
      client: client0
      failPoint:
        configureFailPoint: failCommand
        mode:
          times: 2
        data:
          failCommands:
          - find
          - saslStart
          errorCode: 391 # ReauthenticationRequired
  - name: find
    object: collection0
    arguments:
      filter: {}
    expectError: { errorCode: 391 }
  expectEvents:
  - client: client0
    events:
    - commandStartedEvent:
        command:
          find: collName
          filter: {}
    - commandFailedEvent:
        commandName: find
    - commandStartedEvent:
        command:
          find: collName
          filter: {}
    - commandFailedEvent:
        commandName: find
- description: Write commands should fail if reauthentication fails
  operations:
  - name: failPoint
    object: testRunner
    arguments:
      client: client0
      failPoint:
        configureFailPoint: failCommand
        mode:
          times: 2
        data:
          failCommands:
          - insert
          - saslStart
          errorCode: 391 # ReauthenticationRequired
  - name: insertOne
    object: collection0
    arguments:
      document:
        _id: 1
        x: 1
    expectError: { errorCode: 391 }
  expectEvents:
  - client: client0
    events:
    - commandStartedEvent:
        command:
          insert: collName
          documents:
          - _id: 1
            x: 1
    - commandFailedEvent:
        commandName: insert
    - commandStartedEvent:
        command:
          insert: collName
          documents:
          - _id: 1
            x: 1
    - commandFailedEvent:
        commandName: insert
