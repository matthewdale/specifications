version: 1
style: integration
description: threads blocked by maxConnecting check out returned connections
runOn:
  -
    # required for blockConnection in fail point
    minServerVersion: "4.4.0"
failPoint:
  configureFailPoint: failCommand
  # high amount to ensure not interfered with by monitor checks.
  mode: { times: 50 }
  data:
    failCommands: ["isMaster","hello"]
    closeConnection: false
    blockConnection: true
    blockTimeMS: 750
poolOptions:
  maxPoolSize: 10
  waitQueueTimeoutMS: 5000
operations:
  - name: ready
  # check out 3 connections and hold on to them.
  - name: checkOut
    label: conn1
  - name: checkOut
    label: conn2
  - name: checkOut
    label: conn3
  # then start three threads that all attempt to check out. Two threads
  # will fill maxConnecting, and the other should be waiting either for
  # the other two to finish or for the main thread to check its connection
  # back in.
  - name: start
    target: thread1
  - name: checkOut
    thread: thread1
  - name: start
    target: thread2
  - name: checkOut
    thread: thread2
  - name: start
    target: thread3
  - name: checkOut
    thread: thread3
  # wait for all three to start checking out and a little longer
  # for the establishments to begin.
  - name: waitForEvent
    event: ConnectionCheckOutStarted
    count: 6
  - name: wait
    ms: 100
  # check original 3 connections back in, so all 3 of the waiting threads are
  # unblocked. Wait 20ms between each checkIn so the checkIn/checkOut event
  # order is more reliable. Then wait for all threads to complete.
  - name: checkIn
    connection: conn1
  - name: wait
    ms: 20
  - name: checkIn
    connection: conn2
  - name: wait
    ms: 20
  - name: checkIn
    connection: conn3
  - name: waitForEvent
    event: ConnectionCheckedOut
    count: 6
events:
  # Main thread checking out 3 connections and holding them.
  - type: ConnectionCreated
    address: 42
    connectionId: 1
  - type: ConnectionCheckedOut
    address: 42
  - type: ConnectionCreated
    address: 42
    connectionId: 2
  - type: ConnectionCheckedOut
    address: 42
  - type: ConnectionCreated
    address: 42
    connectionId: 3
  - type: ConnectionCheckedOut
    address: 42
  # Two threads creating their connections, limited by maxConnecting.
  - type: ConnectionCreated
    address: 42
  - type: ConnectionCreated
    address: 42
  # Main thread checking its 3 connections back in.
  - type: ConnectionCheckedIn
    address: 42
    connectionId: 1
  - type: ConnectionCheckedOut
    address: 42
    connectionId: 1
  - type: ConnectionCheckedIn
    address: 42
    connectionId: 2
  - type: ConnectionCheckedOut
    address: 42
    connectionId: 2
  - type: ConnectionCheckedIn
    address: 42
    connectionId: 3
  - type: ConnectionCheckedOut
    address: 42
    connectionId: 3
ignore:
  - ConnectionPoolReady
  - ConnectionClosed
  - ConnectionReady
  - ConnectionPoolCreated
  - ConnectionCheckOutStarted
